<!-- src/app/pages/dtr/dtr.component.html -->
<div class="page">

  <div class="page-header">
    <div>
      <h1 class="page-title">DTR Records</h1>
      <p class="page-sub">Daily Time Record — {{ filtered().length }} entries</p>
    </div>
    <button class="btn-compute" (click)="computeDtr()" [disabled]="computing()">
      {{ computing() ? 'Computing...' : '⚡ Compute DTR' }}
    </button>
  </div>

  @if (computeMsg()) {
    <div class="compute-msg" [class.compute-error]="computeError()">
      {{ computeMsg() }}
    </div>
  }

  <div class="filters">
    <div class="filter-group">
      <label>EMPLOYEE</label>
      <select [value]="selectedEmployee()" (change)="onEmployeeChange($event)">
        <option value="">All Employees</option>
        @for (emp of employees(); track emp.id) {
          <option [value]="emp.id">{{ emp.name }}</option>
        }
      </select>
    </div>
    <div class="filter-group">
      <label>FROM</label>
      <input type="date" [value]="fromDate()" (change)="onFromDateChange($event)" />
    </div>
    <div class="filter-group">
      <label>TO</label>
      <input type="date" [value]="toDate()" (change)="onToDateChange($event)" />
    </div>
    <button class="btn-clear" (click)="clearFilters()">Clear</button>
  </div>

  @if (loading()) {
    <div class="loading">Loading records...</div>
  } @else if (filtered().length === 0) {
    <div class="empty">No DTR records found. Upload a CSV and compute DTR.</div>
  } @else {
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th rowspan="2" class="th-employee">EMPLOYEE</th>
            <th rowspan="2" class="th-date" (click)="toggleSort()">
              DATE <span class="sort-arrow">{{ sortAsc() ? '↑' : '↓' }}</span>
            </th>
            <th colspan="2" class="th-group">A.M.</th>
            <th colspan="2" class="th-group">P.M.</th>
            <th rowspan="2" class="th-status">STATUS</th>
          </tr>
          <tr>
            <th class="th-time">IN</th>
            <th class="th-time">OUT</th>
            <th class="th-time">IN</th>
            <th class="th-time">OUT</th>
          </tr>
        </thead>
        <tbody>
          @for (r of sorted(); track r.id) {
            <tr [class.row-incomplete]="isIncomplete(r)">
              <td class="td-employee">
                <div class="emp-name">{{ r.name }}</div>
                <div class="emp-meta">
                  ID: {{ r.employee_id }}
                  @if (r.department) { · {{ r.department }} }
                </div>
              </td>
              <td class="td-date">{{ formatDate(r.date) }}</td>
              <td class="td-time">{{ formatTime(r.am_in) }}</td>
              <td class="td-time">{{ formatTime(r.am_out) }}</td>
              <td class="td-time">{{ formatTime(r.pm_in) }}</td>
              <td class="td-time">{{ formatTime(r.pm_out) }}</td>
              <td class="td-status">
                @if (!r.am_in && !r.pm_in) {
                  <span class="badge badge-absent">Absent</span>
                } @else if ((!r.am_out && r.am_in) || (!r.pm_out && r.pm_in && !r.am_out)) {
                  <span class="badge badge-missing">Incomplete</span>
                } @else {
                  <span class="badge badge-ok">Complete</span>
                }
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
</div>